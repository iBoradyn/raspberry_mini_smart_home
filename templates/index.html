{% load i18n %}
{% csrf_token %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% trans 'Manage watering system' %}</title>
</head>
<body>
  <h1>{% trans 'Manage watering system' %}</h1>
  <h3>{% trans 'Click button to start/stop watering.' %}</h3>

  <button id="watering_btn">Start</button>

  <script>
    function getCookie(name) {
      if (!document.cookie) {
        return null;
      }

      const xsrfCookies = document.cookie.split(';')
        .map(c => c.trim())
        .filter(c => c.startsWith(name + '='));

      if (xsrfCookies.length === 0) {
        return null;
      }
      return decodeURIComponent(xsrfCookies[0].split('=')[1]);
    }
  </script>

  <script>
    window.addEventListener("load", () => {
      let pumpOn = false;
      const csrfToken = getCookie('csrftoken');
      const btn = document.getElementById('watering_btn');

      btn.addEventListener('click', () => {
        let url = "{% url 'watering_system:turn_on_pump' %}";
        if(pumpOn) {
            url = "{% url 'watering_system:turn_off_pump' %}"
        }
        let xhr = new XMLHttpRequest();

        xhr.open("POST", url, true);
        xhr.setRequestHeader('X-CSRFToken', csrfToken);
        xhr.onreadystatechange = function () {
            if(this.status < 400) {
              pumpOn = !pumpOn;

              if(pumpOn) {
                btn.innerHTML = 'Stop'
              } else {
                btn.innerHTML = 'Start'
              }
            }
        }

        xhr.send();
      })
    })
  </script>
</body>
</html>